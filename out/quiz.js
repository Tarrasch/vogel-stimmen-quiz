!function(){"use strict";function e(e){return{soundFileUrl:e.file,recorderName:e.rec,englishName:e.en,genericName:e.gen,scientificName:e.sp,id:e.id,url:e.url}}var t=function(e,t,n,i){return new(n||(n=Promise))(function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function c(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,c)}u((i=i.apply(e,t||[])).next())})};function n(e){return`${e.birdQueryName} area:europe q:A type:song`}function i(e){return Math.floor(Math.random()*e)}class r{constructor(e){this.birdsInQuiz=e,this.numRecordingsMap=new Map,this.recordingsMap=new Map}maybeGetNumRecordings(e){return this.numRecordingsMap.get(e)}maybeGetBirdRecording(e,t){return this.recordingsMap.get([e,t])}saveResult(e,t){this.numRecordingsMap.set(e,t.numRecordings);for(let n=0;n<t.recordings.length;n++){const i=t.recordings[n],r=n+100*(t.page-1);this.recordingsMap.set([e,r],i)}}}class s{constructor(e){this.birdsInQuiz=e,this.storage=new r(e)}getNumRecordingsInXenoCanto(e){return t(this,void 0,void 0,function*(){const t=this.storage.maybeGetNumRecordings(e);if(!t){const t=yield this.fetchApiResponse({query:n({birdQueryName:this.birdsInQuiz[e].scientificName}),pageNumber:1});return this.storage.saveResult(e,t),t.numRecordings}return t})}getBirdRecording(e,i){return t(this,void 0,void 0,function*(){const t=this.storage.maybeGetBirdRecording(e,i);if(!t){const t=yield this.fetchApiResponse({query:n({birdQueryName:this.birdsInQuiz[e].scientificName}),pageNumber:i/100+1});return this.storage.saveResult(e,t),t.recordings[i%100]}return t})}fetchApiResponse(t){return fetch(function(e){return`https://jsonp.afeld.me/?url=${`https://www.xeno-canto.org/api/2/recordings?query=${e.query}&page=${e.pageNumber}`}`}(t)).then(e=>e.json()).then(t=>(function(t){return{numRecordings:parseInt(t.numRecordings),page:t.page,numPages:t.numPages,recordings:t.recordings.map(e)}})(t))}}class o{constructor(e,t){this.birdsInQuiz=e,this.fetcher=new s(e),this.numOptions=t}getNewRound(){return t(this,void 0,void 0,function*(){const e=function(e,t){if(t>e)return console.log("ERROR!!! outputLength > max"),[-999999];const n=Array(e).fill(void 0).map((e,t)=>t);for(let r=0;r<t-1;r++){const t=r+i(e-r),s=n[r],o=n[t];n[r]=o,n[t]=s}return n.slice(0,t)}(this.birdsInQuiz.length,this.numOptions),t=e.map(e=>this.birdsInQuiz[e]),n=e[i(this.numOptions)],r=i(yield this.fetcher.getNumRecordingsInXenoCanto(n)),s=yield this.fetcher.getBirdRecording(n,r);return{correctBird:this.birdsInQuiz[n],recording:s,birdOptions:t}})}}const c=[{scientificName:"Parus Major",germanName:"Kohlmeise"},{scientificName:"Cyanistes Caeruleus",germanName:"Blaumeise"},{scientificName:"Periparus Ater",germanName:"Tannenmeise"},{scientificName:"Dendrocopos Major",germanName:"Buntspecht"},{scientificName:"Troglodytes Troglodytes",germanName:"Zaunkönig"},{scientificName:"Erithacus Rubecula",germanName:"Rotkehlchen"},{scientificName:"Phylloscopus Collybita",germanName:"Zilpzalp"},{scientificName:"Sitta Europaea",germanName:"Kleiber"},{scientificName:"Garrulus Glandarius",germanName:"Eichelhäher"}];function u(e){const t=e.get("species");if(!t)return c;let n=[];for(let e of t.split(",")){const t=a(e);null!=t&&n.push(t)}return n}function a(e){for(let t of c)if(e===t.scientificName)return t}function d(e){const t=parseInt(e.get("numOptions")||"4");return Number.isNaN(t)?4:t}function m(){return document.getElementById("answer-p")}function g(){return document.getElementById("recordist-attribution")}function h(e){f(),e.getNewRound().then(e=>{!function(e,t,n){f();const i=document.getElementById("audio");i.src=n.soundFileUrl,i.play();const r=document.getElementById("choices");for(const i of t){const t=i.scientificName===e.scientificName,s=document.createElement("button");s.textContent=i.germanName,s.addEventListener("click",e=>{m().textContent=`${i.germanName} ist ${t?"RICHTIG":"FALSCH"}`,t&&(g().textContent=`Aufname XC${n.id} [${n.recorderName}]`,g().href=`https:${n.url}`)}),r.appendChild(s)}}(e.correctBird,e.birdOptions,e.recording)})}function f(){const e=document.getElementById("choices");for(;e.firstChild;)e.removeChild(e.firstChild);m().textContent="",g().textContent="",g().href=""}document.addEventListener("DOMContentLoaded",function(){const e=new URLSearchParams(document.location.search.substring(1)),t=function(e){return{species:u(e),numOptions:d(e)}}(e),n=t.species,i=new o(n,Math.min(n.length,t.numOptions));!function(e){const t=new URL("quiz_starter.html",document.URL);t.search=e.toString(),document.getElementById("edit-quiz").setAttribute("href",t.href)}(e),function(e){document.getElementById("next-question").addEventListener("click",t=>{h(e)})}(i),h(i)})}();
