!function(){"use strict";function e(e,t){if(t>e)return console.log("ERROR!!! outputLength > max"),[-999999];const i=Array(e).fill(void 0).map(((e,n)=>n));return function(e){for(let t=0;t<e.length-1;t++){const i=t+n(e.length-t);[e[t],e[i]]=[e[i],e[t]]}}(i),i.slice(0,t)}function n(e){return t(e,Math.random())}function t(e,n=Math.random()){return Math.floor(n*e)}function i(i){const r=e(i.numBirdsInQuiz,i.numOptions),o=Math.random();return{optionIndexes:r,correctOptionIndex:r[n(i.numOptions)],getStartIndexFromNumRecordings:e=>t(e,o)}}function r(e){return{soundFileUrl:e.file,recorderName:e.rec,englishName:e.en,genericName:e.gen,scientificName:e.sp,id:e.id,url:e.url,also:(n=e.also,1===n.length&&""===n[0]?[]:n)};var n}var o=function(e,n,t,i){return new(t||(t=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function c(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,c)}u((i=i.apply(e,n||[])).next())}))};function s(e){return`${e.birdQueryName} area:europe q:A type:song`}class c{constructor(e){this.birdsInQuiz=e,this.numRecordingsMap=new Map,this.recordingsMap=new Map}maybeGetNumRecordings(e){return this.numRecordingsMap.get(e)}maybeGetBirdRecording(e,n){return this.recordingsMap.get(`${e}-${n}`)}saveResult(e,n){this.numRecordingsMap.set(e,n.numRecordings);for(let t=0;t<n.recordings.length;t++){const i=n.recordings[t],r=t+500*(n.page-1);this.recordingsMap.set(`${e}-${r}`,i)}}}class u{constructor(e){this.birdsInQuiz=e,this.storage=new c(e)}getNumRecordingsInXenoCanto(e){return o(this,void 0,void 0,(function*(){const n=this.storage.maybeGetNumRecordings(e);if(!n){const n=yield this.fetchApiResponse({query:s({birdQueryName:this.birdsInQuiz[e].scientificName}),pageNumber:1});return this.storage.saveResult(e,n),n.numRecordings}return n}))}getBirdRecording(e,n){return o(this,void 0,void 0,(function*(){const t=this.storage.maybeGetBirdRecording(e,n);if(!t){const t=yield this.fetchApiResponse({query:s({birdQueryName:this.birdsInQuiz[e].scientificName}),pageNumber:Math.trunc(n/500+1)});return this.storage.saveResult(e,t),t.recordings[n%500]}return t}))}fetchApiResponse(e){return fetch(function(e){return`https://famous-hull-347520.ue.r.appspot.com/simple-xeno-canto?query=${e.query}&page=${e.pageNumber}`}(e)).then((e=>e.json())).then((e=>{return n=e,{numRecordings:parseInt(n.numRecordings),page:n.page,numPages:n.numPages,recordings:n.recordings.map(r)};var n}))}}class a{constructor(e,n){this.birdsInQuiz=e,this.fetcher=new u(e),this.numOptions=n;const t=e.length;this.nextRandomData=i({numBirdsInQuiz:t,numOptions:n})}getGoodBirdRecording(e){return o(this,void 0,void 0,(function*(){const n=e.correctOptionIndex,t=yield this.fetcher.getNumRecordingsInXenoCanto(n);let i=e.getStartIndexFromNumRecordings(t),r=0;for(;;){const e=yield this.fetcher.getBirdRecording(n,i),o=r>=30;if(0===e.also.length||o)return e;i=(i+1)%t,r++}}))}getNewRoundUsingRandomData(e){return o(this,void 0,void 0,(function*(){const n=e.optionIndexes.map((e=>this.birdsInQuiz[e])),t=yield this.getGoodBirdRecording(e);return{correctBird:this.birdsInQuiz[e.correctOptionIndex],recording:t,birdOptions:n}}))}preFetchNextRound(){this.getNewRoundUsingRandomData(this.nextRandomData)}getNewRound(){return o(this,void 0,void 0,(function*(){const e=yield this.getNewRoundUsingRandomData(this.nextRandomData);return this.nextRandomData=i({numBirdsInQuiz:this.birdsInQuiz.length,numOptions:this.numOptions}),e}))}}const d=[{scientificName:"Parus Major",germanName:"Kohlmeise"},{scientificName:"Cyanistes Caeruleus",germanName:"Blaumeise"},{scientificName:"Periparus Ater",germanName:"Tannenmeise"},{scientificName:"Fringilla Coelebs",germanName:"Buchfink"},{scientificName:"Dendrocopos Major",germanName:"Buntspecht"},{scientificName:"Troglodytes Troglodytes",germanName:"Zaunkönig"},{scientificName:"Erithacus Rubecula",germanName:"Rotkehlchen"},{scientificName:"Phylloscopus Collybita",germanName:"Zilpzalp"},{scientificName:"Sitta Europaea",germanName:"Kleiber"},{scientificName:"Garrulus Glandarius",germanName:"Eichelhäher"}];function m(e){const n=e.get("species");if(!n)return d;let t=[];for(let e of n.split(",")){const n=g(e);null!=n&&t.push(n)}return t}function g(e){for(let n of d)if(e===n.scientificName)return n}function h(e){const n=parseInt(e.get("numOptions")||"4");return Number.isNaN(n)?4:n}function l(){return document.getElementById("answer-p")}function f(){return document.getElementById("recordist-attribution")}function p(){return Array.from(document.getElementsByClassName("choice-button"))}function N(e){e.outerHTML=e.outerHTML}function R(e){y(),e.getNewRound().then((n=>{e.preFetchNextRound(),function(e,n,t){y();const i=document.getElementById("audio");i.src=t.soundFileUrl,i.play();for(let i=0;i<n.length;i++){const r=n[i],o=p()[i],s=r.scientificName===e.scientificName;o.textContent=r.germanName,o.addEventListener("click",(e=>{b(r,s,t)}))}}(n.correctBird,n.birdOptions,n.recording)}))}function y(){for(const e of p())e.disabled=!1,e.textContent="",N(e);l().textContent="",f().textContent="",f().href=""}function b(e,n,t){if(l().textContent=`${e.germanName} ist ${n?"RICHTIG":"FALSCH"}`,n){f().textContent=`Aufname XC${t.id} [${t.recorderName}]`,f().href=`https:${t.url}`;const n=p().filter((n=>n.textContent!==e.germanName));for(const e of n)e.disabled=!0}}document.addEventListener("DOMContentLoaded",(function(){const e=new URLSearchParams(document.location.search.substring(1)),n=function(e){return{species:m(e),numOptions:h(e)}}(e),t=n.species,i=new a(t,Math.min(t.length,n.numOptions));!function(e){const n=document.getElementById("choices");for(let t=0;t<e;t++){const e=document.createElement("button");e.className="choice-button",n.appendChild(e)}}(i.numOptions),function(e){const n=new URL("quiz_starter.html",document.URL);n.search=e.toString(),document.getElementById("edit-quiz").setAttribute("href",n.href)}(e),function(e){document.getElementById("next-question").addEventListener("click",(n=>{R(e)}))}(i),R(i)}))}();
