!function(){"use strict";function e(e,n){if(n>e)return console.log("ERROR!!! outputLength > max"),[-999999];const i=Array(e).fill(void 0).map(((e,t)=>t));return function(e){for(let n=0;n<e.length-1;n++){const i=n+t(e.length-n);[e[n],e[i]]=[e[i],e[n]]}}(i),i.slice(0,n)}function t(e){return n(e,Math.random())}function n(e,t=Math.random()){return Math.floor(t*e)}function i(i){const r=e(i.numBirdsInQuiz,i.numOptions),o=Math.random();return{optionIndexes:r,correctOptionIndex:r[t(i.numOptions)],getStartIndexFromNumRecordings:e=>n(e,o)}}function r(e){return{soundFileUrl:e.file,recorderName:e.rec,englishName:e.en,genericName:e.gen,scientificName:e.sp,id:e.id,url:e.url,also:(t=e.also,1===t.length&&""===t[0]?[]:t)};var t}var o=function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function c(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}u((i=i.apply(e,t||[])).next())}))};function s(e){return`${e.birdQueryName} area:europe q:A type:song`}class c{constructor(e){this.birdsInQuiz=e,this.numRecordingsMap=new Map,this.recordingsMap=new Map}maybeGetNumRecordings(e){return this.numRecordingsMap.get(e)}maybeGetBirdRecording(e,t){return this.recordingsMap.get(`${e}-${t}`)}saveResult(e,t){this.numRecordingsMap.set(e,t.numRecordings);for(let n=0;n<t.recordings.length;n++){const i=t.recordings[n],r=n+500*(t.page-1);this.recordingsMap.set(`${e}-${r}`,i)}}}class u{constructor(e){this.birdsInQuiz=e,this.storage=new c(e)}getNumRecordingsInXenoCanto(e){return o(this,void 0,void 0,(function*(){const t=this.storage.maybeGetNumRecordings(e);if(!t){const t=yield this.fetchApiResponse({query:s({birdQueryName:this.birdsInQuiz[e].scientificName}),pageNumber:1});return this.storage.saveResult(e,t),t.numRecordings}return t}))}getBirdRecording(e,t){return o(this,void 0,void 0,(function*(){const n=this.storage.maybeGetBirdRecording(e,t);if(!n){const n=yield this.fetchApiResponse({query:s({birdQueryName:this.birdsInQuiz[e].scientificName}),pageNumber:Math.trunc(t/500+1)});return this.storage.saveResult(e,n),n.recordings[t%500]}return n}))}fetchApiResponse(e){return fetch(function(e){return`https://famous-hull-347520.ue.r.appspot.com/simple-xeno-canto?query=${e.query}&page=${e.pageNumber}`}(e)).then((e=>e.json())).then((e=>{return t=e,{numRecordings:parseInt(t.numRecordings),page:t.page,numPages:t.numPages,recordings:t.recordings.map(r)};var t}))}}class a{constructor(e,t){this.birdsInQuiz=e,this.fetcher=new u(e),this.numOptions=t;const n=e.length;this.nextRandomData=i({numBirdsInQuiz:n,numOptions:t})}getGoodBirdRecording(e){return o(this,void 0,void 0,(function*(){const t=e.correctOptionIndex,n=yield this.fetcher.getNumRecordingsInXenoCanto(t);let i=e.getStartIndexFromNumRecordings(n),r=0;for(;;){const e=yield this.fetcher.getBirdRecording(t,i),o=r>=30;if(0===e.also.length||o)return e;i=(i+1)%n,r++}}))}getNewRoundUsingRandomData(e){return o(this,void 0,void 0,(function*(){const t=e.optionIndexes.map((e=>this.birdsInQuiz[e])),n=yield this.getGoodBirdRecording(e);return{correctBird:this.birdsInQuiz[e.correctOptionIndex],recording:n,birdOptions:t}}))}preFetchNextRound(){this.getNewRoundUsingRandomData(this.nextRandomData)}getNewRound(){return o(this,void 0,void 0,(function*(){const e=yield this.getNewRoundUsingRandomData(this.nextRandomData);return this.nextRandomData=i({numBirdsInQuiz:this.birdsInQuiz.length,numOptions:this.numOptions}),e}))}}var d;!function(e){e[e.EASY=0]="EASY",e[e.MEDIUM=1]="MEDIUM",e[e.HARD=2]="HARD"}(d||(d={}));const m=[{scientificName:"Anas Platyrhynchos",germanName:"Stockente",difficulty:d.EASY},{scientificName:"Cinclus Cinclus",germanName:"Wasseramsel",difficulty:d.HARD},{scientificName:"Cyanistes Caeruleus",germanName:"Blaumeise",difficulty:d.EASY},{scientificName:"Erithacus Rubecula",germanName:"Rotkehlchen",difficulty:d.MEDIUM},{scientificName:"Fringilla Coelebs",germanName:"Buchfink",difficulty:d.EASY},{scientificName:"Hirundo Rustica",germanName:"Rauchschwalbe",difficulty:d.MEDIUM},{scientificName:"Parus Major",germanName:"Kohlmeise",difficulty:d.EASY},{scientificName:"Periparus Ater",germanName:"Tannenmeise",difficulty:d.MEDIUM},{scientificName:"Phylloscopus Collybita",germanName:"Zilpzalp",difficulty:d.EASY},{scientificName:"Regulus Ignicapilla",germanName:"Sommergoldhähnchen",difficulty:d.HARD},{scientificName:"Regulus Regulus",germanName:"Wintergoldhähnchen",difficulty:d.HARD},{scientificName:"Troglodytes Troglodytes",germanName:"Zaunkönig",difficulty:d.MEDIUM},{scientificName:"Sitta Europaea",germanName:"Kleiber",difficulty:d.MEDIUM}];function f(e){const t=e.get("species");if(!t)return m;let n=[];for(let e of t.split(",")){const t=l(e);null!=t&&n.push(t)}return n}function l(e){for(let t of m)if(e===t.scientificName)return t}function g(e){const t=parseInt(e.get("numOptions")||"4");return Number.isNaN(t)?4:t}function h(){return document.getElementById("answer-p")}function p(){return document.getElementById("recordist-attribution")}function N(){return Array.from(document.getElementsByClassName("choice-button"))}function R(e){e.outerHTML=e.outerHTML}function y(e){I(),e.getNewRound().then((t=>{e.preFetchNextRound(),function(e,t,n){I();const i=document.getElementById("audio");i.src=n.soundFileUrl,i.play();for(let i=0;i<t.length;i++){const r=t[i],o=N()[i],s=r.scientificName===e.scientificName;o.textContent=r.germanName,o.addEventListener("click",(e=>{b(r,s,n)}))}}(t.correctBird,t.birdOptions,t.recording)}))}function I(){for(const e of N())e.disabled=!1,e.textContent="",R(e);h().textContent="",p().textContent="",p().href=""}function b(e,t,n){if(h().textContent=`${e.germanName} ist ${t?"RICHTIG":"FALSCH"}`,t){p().textContent=`Aufname XC${n.id} [${n.recorderName}]`,p().href=`https:${n.url}`;const t=N().filter((t=>t.textContent!==e.germanName));for(const e of t)e.disabled=!0}}document.addEventListener("DOMContentLoaded",(function(){const e=new URLSearchParams(document.location.search.substring(1)),t=function(e){return{species:f(e),numOptions:g(e)}}(e),n=t.species,i=new a(n,Math.min(n.length,t.numOptions));!function(e){const t=document.getElementById("choices");for(let n=0;n<e;n++){const e=document.createElement("button");e.className="choice-button",t.appendChild(e)}}(i.numOptions),function(e){const t=new URL("quiz_starter.html",document.URL);t.search=e.toString(),document.getElementById("edit-quiz").setAttribute("href",t.href)}(e),function(e){document.getElementById("next-question").addEventListener("click",(t=>{y(e)}))}(i),y(i)}))}();
