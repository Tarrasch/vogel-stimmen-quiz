!function(){"use strict";function e(e){return{soundFileUrl:e.file,recorderName:e.rec,englishName:e.en,genericName:e.gen,scientificName:e.sp,id:e.id,url:e.url,also:(t=e.also,1===t.length&&""===t[0]?[]:t)};var t}var t=function(e,t,n,i){return new(n||(n=Promise))(function(r,o){function s(e){try{u(i.next(e))}catch(e){o(e)}}function c(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,c)}u((i=i.apply(e,t||[])).next())})};const n=500;function i(e){return`${e.birdQueryName} area:europe q:A type:song`}function r(e){return Math.floor(Math.random()*e)}class o{constructor(e){this.birdsInQuiz=e,this.numRecordingsMap=new Map,this.recordingsMap=new Map}maybeGetNumRecordings(e){return this.numRecordingsMap.get(e)}maybeGetBirdRecording(e,t){return this.recordingsMap.get(`${e}-${t}`)}saveResult(e,t){this.numRecordingsMap.set(e,t.numRecordings);for(let i=0;i<t.recordings.length;i++){const r=t.recordings[i],o=i+(t.page-1)*n;this.recordingsMap.set(`${e}-${o}`,r)}}}class s{constructor(e){this.birdsInQuiz=e,this.storage=new o(e)}getNumRecordingsInXenoCanto(e){return t(this,void 0,void 0,function*(){const t=this.storage.maybeGetNumRecordings(e);if(!t){const t=yield this.fetchApiResponse({query:i({birdQueryName:this.birdsInQuiz[e].scientificName}),pageNumber:1});return this.storage.saveResult(e,t),t.numRecordings}return t})}getBirdRecording(e,r){return t(this,void 0,void 0,function*(){const t=this.storage.maybeGetBirdRecording(e,r);if(!t){const t=yield this.fetchApiResponse({query:i({birdQueryName:this.birdsInQuiz[e].scientificName}),pageNumber:Math.trunc(r/n+1)});return this.storage.saveResult(e,t),t.recordings[r%n]}return t})}fetchApiResponse(t){return fetch(function(e){return`https://famous-hull-347520.ue.r.appspot.com/simple-xeno-canto?query=${e.query}&page=${e.pageNumber}`}(t)).then(e=>e.json()).then(t=>(function(t){return{numRecordings:parseInt(t.numRecordings),page:t.page,numPages:t.numPages,recordings:t.recordings.map(e)}})(t))}}class c{constructor(e,t){this.birdsInQuiz=e,this.fetcher=new s(e),this.numOptions=t}getGoodBirdRecording(e){return t(this,void 0,void 0,function*(){const t=yield this.fetcher.getNumRecordingsInXenoCanto(e);let n=r(t),i=0;for(;;){const r=yield this.fetcher.getBirdRecording(e,n),o=i>=30;if(0===r.also.length||o)return r;n=(n+1)%t,i++}})}getNewRound(){return t(this,void 0,void 0,function*(){const e=function(e,t){if(t>e)return console.log("ERROR!!! outputLength > max"),[-999999];const n=Array(e).fill(void 0).map((e,t)=>t);for(let i=0;i<t-1;i++){const t=i+r(e-i),o=n[i],s=n[t];n[i]=s,n[t]=o}return n.slice(0,t)}(this.birdsInQuiz.length,this.numOptions),t=e.map(e=>this.birdsInQuiz[e]),n=e[r(this.numOptions)],i=yield this.getGoodBirdRecording(n);return{correctBird:this.birdsInQuiz[n],recording:i,birdOptions:t}})}}const u=[{scientificName:"Parus Major",germanName:"Kohlmeise"},{scientificName:"Cyanistes Caeruleus",germanName:"Blaumeise"},{scientificName:"Periparus Ater",germanName:"Tannenmeise"},{scientificName:"Dendrocopos Major",germanName:"Buntspecht"},{scientificName:"Troglodytes Troglodytes",germanName:"Zaunkönig"},{scientificName:"Erithacus Rubecula",germanName:"Rotkehlchen"},{scientificName:"Phylloscopus Collybita",germanName:"Zilpzalp"},{scientificName:"Sitta Europaea",germanName:"Kleiber"},{scientificName:"Garrulus Glandarius",germanName:"Eichelhäher"}];function a(e){const t=e.get("species");if(!t)return u;let n=[];for(let e of t.split(",")){const t=d(e);null!=t&&n.push(t)}return n}function d(e){for(let t of u)if(e===t.scientificName)return t}function m(e){const t=parseInt(e.get("numOptions")||"4");return Number.isNaN(t)?4:t}function g(){return document.getElementById("answer-p")}function h(){return document.getElementById("recordist-attribution")}function l(e){f(),e.getNewRound().then(e=>{!function(e,t,n){f();const i=document.getElementById("audio");i.src=n.soundFileUrl,i.play();const r=document.getElementById("choices");for(const i of t){const t=i.scientificName===e.scientificName,o=document.createElement("button");o.textContent=i.germanName,o.addEventListener("click",e=>{g().textContent=`${i.germanName} ist ${t?"RICHTIG":"FALSCH"}`,t&&(h().textContent=`Aufname XC${n.id} [${n.recorderName}]`,h().href=`https:${n.url}`)}),r.appendChild(o)}}(e.correctBird,e.birdOptions,e.recording)})}function f(){const e=document.getElementById("choices");for(;e.firstChild;)e.removeChild(e.firstChild);g().textContent="",h().textContent="",h().href=""}document.addEventListener("DOMContentLoaded",function(){const e=new URLSearchParams(document.location.search.substring(1)),t=function(e){return{species:a(e),numOptions:m(e)}}(e),n=t.species,i=new c(n,Math.min(n.length,t.numOptions));!function(e){const t=new URL("quiz_starter.html",document.URL);t.search=e.toString(),document.getElementById("edit-quiz").setAttribute("href",t.href)}(e),function(e){document.getElementById("next-question").addEventListener("click",t=>{l(e)})}(i),l(i)})}();
